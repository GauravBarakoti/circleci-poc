version: 2.1
# The version field is intended to be used in order to issue warnings for deprecation or breaking changes.
jobs:
# A Workflow is comprised of one or more uniquely named jobs.
  runner-deploy:
  # Name for a job, can be anything
    machine: true
    # The virtual machine image to use. 
    resource_class: k8vhsqovhlv8kmbfzecxgd/docker
    # The resource_class feature allows you to configure CPU and RAM resources for each job.
    working_directory: ~/my-app
    # Not Required, In which directory to run the steps. Will be interpreted as an absolute path. (default: .)
    steps:
    # A list of steps to be performed.
      - checkout
      # the checkout step will checkout project source code into the jobâ€™s working_directory
      - run:
      # Used for invoking all command-line programs
          name: Remove previous Image If Any keep last 2 version
          # Command to run via the shell
          command: |
            if [[ "$(docker images mysampleimage:`expr ${CIRCLE_BUILD_NUM} - 2 `)" != "" ]]; then
              docker rmi $(docker images mysampleimage:`expr ${CIRCLE_BUILD_NUM} - 2 ` -q)
            fi
      - run: 
          name: Build Docker Image
          command: docker build -t mysampleimage:${CIRCLE_BUILD_NUM} .
          # fix this with image tag and keep 2 previous version of the image
      - run: sudo systemctl reload apache2
      - run:
          name: Stop and Remove Container first
          command: |
            if [[ "$(docker ps --filter name=first -aq)" != "" ]]; then
              sleep 5
              docker container stop $(docker ps --filter name=first -aq)
              sleep 5
              docker container rm $(docker ps --filter name=first -aq)
            fi
      - run: 
          name: Run Container 1
          command: docker container run --name first -d -p 8081:5000 mysampleimage:${CIRCLE_BUILD_NUM}
      - run: sudo systemctl reload apache2
      - run:
          name: Waiting to stable the app
          command: sleep 15
      - run:
          name: Stop and Remove Container Second
          command: |
            if [[ "$(docker ps --filter name=second -aq)" != "" ]]; then
              docker container stop $(docker ps --filter name=second -aq)
              sleep 5
              docker container rm $(docker ps --filter name=second -aq)
            fi
      - run: 
          name: Run Container 2
          command: docker container run --name second -d -p 8082:5000 mysampleimage:${CIRCLE_BUILD_NUM}
      - run: sudo systemctl reload apache2


workflows:
# Used for orchestrating all jobs.
  version: 2
  # The Workflows version field is used to issue warnings for deprecation or breaking changes. Required if config version is 2
  build-deploy:
    jobs:
    # A job name that exists in your config.yml
      - runner-deploy
